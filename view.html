<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curriculum Vitae</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
         import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
         
         // CONFIG FIREBASE (WAJIB ADA DISINI JUGA)
         const firebaseConfig = {
            apiKey: "AIzaSyBf7cQ_Bt6gM2l5KOy2goXnm-jDKRE45f8",
            authDomain: "resume-ceb60.firebaseapp.com",
            databaseURL: "https://resume-ceb60-default-rtdb.firebaseio.com",
            projectId: "resume-ceb60",
            storageBucket: "resume-ceb60.firebasestorage.app",
            messagingSenderId: "861546140569",
            appId: "1:861546140569:web:2c182feacfff08f5c07908",
            measurementId: "G-1DDJCR9NV3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        const slug = params.get('id');

        if (slug) {
            get(ref(db, 'slugs/' + slug)).then((snap) => {
                if (snap.exists()) {
                    get(ref(db, 'users/' + snap.val())).then((userSnap) => {
                        document.title = "CV - " + userSnap.val().fullName;
                    });
                }
            });
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen py-10 print:bg-white print:py-0">

    <div id="loading" class="text-center mt-20 text-gray-500">Memuat Data CV...</div>

    <div id="cvContent" class="hidden max-w-4xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden print:shadow-none print:w-full">
        
        <header class="bg-slate-800 text-white p-8 flex flex-col md:flex-row items-center gap-6">
            <img id="viewPhoto" src="https://via.placeholder.com/150" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
            <div class="text-center md:text-left flex-1">
                <h1 id="viewName" class="text-3xl font-bold mb-2 uppercase tracking-wide"></h1>
                <div class="flex flex-wrap justify-center md:justify-start gap-4 text-sm text-slate-300">
                    <span><i class="fas fa-map-marker-alt mr-1"></i> <span id="viewLocation"></span></span>
                    <span><i class="fas fa-envelope mr-1"></i> <span id="viewEmail"></span></span>
                    <a id="viewWhatsapp" href="#" target="_blank" class="hover:text-white transition"><i class="fab fa-whatsapp mr-1"></i> WhatsApp</a>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3">
            
            <aside class="bg-slate-50 p-6 md:col-span-1 border-r border-gray-200">
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-800 border-b-2 border-slate-300 mb-3 pb-1">PENDIDIKAN</h3>
                    <div id="viewEducation" class="space-y-4"></div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold text-slate-800 border-b-2 border-slate-300 mb-3 pb-1">KEAHLIAN</h3>
                    <div class="mb-4">
                        <p class="font-semibold text-sm text-slate-600 mb-2">Hard Skills</p>
                        <div id="viewHardSkills" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <p class="font-semibold text-sm text-slate-600 mb-2">Soft Skills</p>
                        <ul id="viewSoftSkills" class="list-disc list-inside text-sm text-gray-700"></ul>
                    </div>
                </div>

                <div id="viewAdditionalContainer" class="hidden mb-8">
                    <h3 class="text-lg font-bold text-slate-800 border-b-2 border-slate-300 mb-3 pb-1">INFO LAIN</h3>
                    <div id="viewAdditional" class="space-y-3"></div>
                </div>
            </aside>

            <main class="p-8 md:col-span-2">
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-3"><i class="fas fa-user-circle mr-2 text-slate-500"></i>Profil Profesional</h3>
                    <p id="viewSummary" class="text-gray-700 leading-relaxed text-justify"></p>
                </div>

                <div>
                    <h3 class="text-xl font-bold text-slate-800 mb-4"><i class="fas fa-briefcase mr-2 text-slate-500"></i>Pengalaman Kerja</h3>
                    <div id="viewExperience" class="border-l-2 border-slate-200 ml-2 space-y-6">
                        </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // GUNAKAN CONFIG YANG SAMA AGAR BISA BACA DB
        const firebaseConfig = {
            apiKey: "AIzaSyBf7cQ_Bt6gM2l5KOy2goXnm-jDKRE45f8",
            authDomain: "resume-ceb60.firebaseapp.com",
            databaseURL: "https://resume-ceb60-default-rtdb.firebaseio.com",
            projectId: "resume-ceb60",
            storageBucket: "resume-ceb60.firebasestorage.app",
            messagingSenderId: "861546140569",
            appId: "1:861546140569:web:2c182feacfff08f5c07908",
            measurementId: "G-1DDJCR9NV3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ambil ID dari URL
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('id');

        if (!slug) {
            document.body.innerHTML = "<h1 class='text-center mt-10 text-red-500'>URL Tidak Valid (ID tidak ditemukan)</h1>";
        } else {
            loadCV(slug);
        }

        async function loadCV(slug) {
            try {
                const slugSnap = await get(ref(db, 'slugs/' + slug));
                if (!slugSnap.exists()) throw new Error("CV tidak ditemukan");

                const uid = slugSnap.val();
                const userSnap = await get(ref(db, 'users/' + uid));
                if (!userSnap.exists()) throw new Error("Data user rusak");

                renderCV(userSnap.val());
            } catch (error) {
                document.getElementById('loading').innerHTML = `<span class="text-red-500 font-bold">${error.message}</span>`;
            }
        }

        function renderCV(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('cvContent').classList.remove('hidden');

            if(data.photo) document.getElementById('viewPhoto').src = data.photo;
            document.getElementById('viewName').innerText = data.fullName;
            document.getElementById('viewLocation').innerText = data.location;
            document.getElementById('viewEmail').innerText = data.email;
            
            // Format WA
            const waLink = `https://wa.me/${data.whatsapp.replace(/[^0-9]/g, '')}`;
            document.getElementById('viewWhatsapp').href = waLink;

            document.getElementById('viewSummary').innerText = data.summary;

            // Experience
            const expContainer = document.getElementById('viewExperience');
            if(data.experience) {
                data.experience.forEach(exp => {
                    const div = document.createElement('div');
                    div.className = "pl-6 relative";
                    div.innerHTML = `
                        <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-slate-400 border-2 border-white"></div>
                        <h4 class="font-bold text-lg text-gray-800">${exp.title}</h4>
                        <span class="text-sm font-semibold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${exp.period}</span>
                        <p class="mt-2 text-gray-600 text-sm whitespace-pre-line">${exp.desc}</p>
                    `;
                    expContainer.appendChild(div);
                });
            }

            // Education
            const eduContainer = document.getElementById('viewEducation');
            if(data.education) {
                data.education.forEach(edu => {
                    if(!edu.school) return;
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <h4 class="font-bold text-gray-800 text-sm">${edu.school}</h4>
                        <p class="text-xs text-gray-600">${edu.degree}</p>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>${edu.year}</span>
                            ${edu.gpa ? `<span class="font-semibold text-slate-700">IPK: ${edu.gpa}</span>` : ''}
                        </div>
                    `;
                    eduContainer.appendChild(div);
                });
            }

            // Skills
            const hardContainer = document.getElementById('viewHardSkills');
            if(data.hardSkills) {
                data.hardSkills.forEach(skill => {
                    const span = document.createElement('span');
                    span.className = "bg-slate-700 text-white text-xs px-2 py-1 rounded";
                    span.innerText = skill;
                    hardContainer.appendChild(span);
                });
            }

            const softContainer = document.getElementById('viewSoftSkills');
            if(data.softSkills) {
                data.softSkills.forEach(skill => {
                    const li = document.createElement('li');
                    li.innerText = skill;
                    softContainer.appendChild(li);
                });
            }

            // Additional
            const addContainer = document.getElementById('viewAdditional');
            if(data.additional && data.additional.length > 0) {
                document.getElementById('viewAdditionalContainer').classList.remove('hidden');
                data.additional.forEach(add => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <p class="text-sm font-bold text-gray-800">${add.title}</p>
                        <p class="text-xs text-gray-600">${add.desc}</p>
                    `;
                    addContainer.appendChild(div);
                });
            }
        }
    </script>
</body>
</html>