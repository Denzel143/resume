<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat CV Anda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .section-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; color: #2563eb; }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Editor CV</h1>
            <div class="flex gap-4">
                <button type="button" id="btnSeeLink" class="text-blue-600 font-semibold hover:underline">
                    Lihat Link Saya
                </button>
                <button id="btnLogout" class="text-red-500 hover:underline">Logout</button>
            </div>
        </div>

        <form id="cvForm" class="space-y-8">
            
            <section>
                <h2 class="section-title">Data Diri</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Foto Profil (3x4)</label>
    
                        <div class="mb-3">
                            <img id="photoPreview" src="" alt="Foto Profil" class="hidden w-24 h-32 object-cover rounded border border-gray-300 shadow-sm">
                            <p id="noPhotoText" class="text-xs text-gray-400 italic mt-1">Belum ada foto tersimpan.</p>
                        </div>

                        <input type="file" id="photoInput" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <input type="hidden" id="photoBase64"> 
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nama Lengkap</label>
                        <input type="text" id="fullName" class="w-full border p-2 rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Lokasi Domisili</label>
                        <input type="text" id="location" placeholder="Kota, Provinsi" class="w-full border p-2 rounded" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Nomor WhatsApp</label>
                        <div class="flex">
                            <select id="countryCode" class="border p-2 rounded-l bg-gray-100 w-24 text-center">
                                <option value="62">+62 (ID)</option>
                                <option value="1">+1 (US)</option>
                                <option value="60">+60 (MY)</option>
                                <option value="65">+65 (SG)</option>
                                <option value="61">+61 (AU)</option>
                            </select>
                            <input type="text" id="whatsapp" class="w-full border p-2 rounded-r" placeholder="812-3456-7890" required>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Otomatis diformat dengan tanda hubung (-)</p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="emailDisplay" class="w-full border p-2 rounded bg-gray-100" readonly>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="section-title">Deskripsi Diri (Professional Summary)</h2>
                <textarea id="summary" rows="4" placeholder="Ceritakan tentang diri Anda dalam 3-5 kalimat..." class="w-full border p-2 rounded" required></textarea>
            </section>

            <section>
                <h2 class="section-title">Pengalaman Kerja (Kronologis Terbalik)</h2>
                <div id="experienceList" class="space-y-4"></div>
                <button type="button" onclick="addExperience()" class="mt-2 text-sm text-blue-600 font-bold">+ Tambah Pengalaman</button>
            </section>

            <section>
                <h2 class="section-title">Pendidikan (2 Terakhir)</h2>
                <div id="educationList" class="space-y-4">
                    </div>
            </section>

            <section>
                <h2 class="section-title">Keahlian (Skills)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">Hard Skills</h3>
                        <div id="hardSkillsList" class="space-y-2"></div>
                        <button type="button" onclick="addSkill('hardSkillsList')" class="mt-2 text-xs text-blue-600">+ Tambah Hard Skill</button>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Soft Skills</h3>
                        <div id="softSkillsList" class="space-y-2"></div>
                        <button type="button" onclick="addSkill('softSkillsList')" class="mt-2 text-xs text-blue-600">+ Tambah Soft Skill</button>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="section-title">Informasi Tambahan (Opsional)</h2>
                <div id="additionalList" class="space-y-4"></div>
                <button type="button" onclick="addAdditional()" class="mt-2 text-sm text-blue-600 font-bold">+ Tambah Info Lain</button>
            </section>

            <div class="pt-6 border-t">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 shadow-lg">
                    POST & BUAT URL CV
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf7cQ_Bt6gM2l5KOy2goXnm-jDKRE45f8",
            authDomain: "resume-ceb60.firebaseapp.com",
            databaseURL: "https://resume-ceb60-default-rtdb.firebaseio.com",
            projectId: "resume-ceb60",
            storageBucket: "resume-ceb60.firebasestorage.app",
            messagingSenderId: "861546140569",
            appId: "1:861546140569:web:2c182feacfff08f5c07908",
            measurementId: "G-1DDJCR9NV3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let savedStateJSON = ""; // Variabel untuk menyimpan state terakhir dari Database

        // --- FUNGSI BARU: Ambil Data Saat Ini dari Form ---
        // Fungsi ini digunakan untuk membandingkan data RAM vs Database
        function getCurrentFormData() {
            const fullName = document.getElementById('fullName').value;
            const urlSlug = fullName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const country = document.getElementById('countryCode').value;
            const rawPhone = document.getElementById('whatsapp').value.replace(/-/g, '');
            const finalPhone = country + rawPhone;

            const formData = {
                fullName: fullName,
                location: document.getElementById('location').value,
                whatsapp: finalPhone,
                email: currentUser ? currentUser.email : "",
                photo: document.getElementById('photoBase64').value,
                summary: document.getElementById('summary').value,
                slug: urlSlug,
                experience: [],
                education: [],
                hardSkills: [],
                softSkills: [],
                additional: []
            };

            document.querySelectorAll('#experienceList > div').forEach(div => {
                formData.experience.push({
                    title: div.querySelector('.exp-title').value,
                    period: div.querySelector('.exp-period').value,
                    desc: div.querySelector('.exp-desc').value
                });
            });

            document.querySelectorAll('#educationList > div').forEach(div => {
                formData.education.push({
                    school: div.querySelector('.edu-school').value,
                    degree: div.querySelector('.edu-degree').value,
                    year: div.querySelector('.edu-year').value,
                    gpa: div.querySelector('.edu-gpa').value
                });
            });

            document.querySelectorAll('#hardSkillsList .skill-input').forEach(i => formData.hardSkills.push(i.value));
            document.querySelectorAll('#softSkillsList .skill-input').forEach(i => formData.softSkills.push(i.value));
            
            document.querySelectorAll('#additionalList > div').forEach(div => {
                formData.additional.push({
                    title: div.querySelector('.add-title').value,
                    desc: div.querySelector('.add-desc').value
                });
            });

            return formData;
        }

        // --- FUNGSI BARU: Cek Perubahan ---
        function checkUnsavedChanges() {
            const currentDataJSON = JSON.stringify(getCurrentFormData());
            return currentDataJSON !== savedStateJSON;
        }

        // LOGIC AUTH & LOAD DATA
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
            } else {
                currentUser = user;
                document.getElementById('emailDisplay').value = user.email;
                await loadUserData(user.uid);
            }
        });

        // UPDATE: Logic Logout dengan Confirm
        document.getElementById('btnLogout').addEventListener('click', () => {
            if (checkUnsavedChanges()) {
                const confirmExit = confirm("Ada perubahan data yang belum disimpan. Yakin ingin keluar tanpa menyimpan?");
                if (!confirmExit) return; // Batal keluar
            }
            signOut(auth).then(() => window.location.href = "index.html");
        });

        // UPDATE: Tombol Lihat Link dengan Confirm
        document.getElementById('btnSeeLink').addEventListener('click', () => {
            const fullName = document.getElementById('fullName').value;
            if (!fullName) {
                alert("Mohon isi Nama Lengkap terlebih dahulu.");
                return;
            }
            
            if (checkUnsavedChanges()) {
                const confirmExit = confirm("Data Anda saat ini berbeda dengan yang tersimpan. Yakin ingin meninggalkan halaman ini tanpa menyimpan?");
                if (!confirmExit) return;
            }

            const urlSlug = fullName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            window.location.href = `overview.html?id=${urlSlug}`;
        });

        // UPDATE: Deteksi Tombol Back Browser / Tutup Tab
        window.addEventListener('beforeunload', (e) => {
            if (checkUnsavedChanges()) {
                // Browser modern mewajibkan ini untuk menampilkan dialog confirm bawaan browser
                e.preventDefault();
                e.returnValue = ''; 
            }
        });

        const phoneInput = document.getElementById('whatsapp');
        phoneInput.addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,4})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        document.getElementById('photoInput').addEventListener('change', function() {
            // Logic ini akan di-override oleh logic Cropper di bawah, 
            // tapi tetap dibiarkan untuk fallback
        });

        // LOGIC DINAMIS
        window.addExperience = (data = {}) => {
            const container = document.getElementById('experienceList');
            const div = document.createElement('div');
            div.className = "p-4 border rounded bg-gray-50 relative group";
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-500 font-bold">X</button>
                <div class="grid grid-cols-1 gap-2">
                    <input type="text" placeholder="Posisi & Perusahaan" class="exp-title w-full border p-2 rounded" value="${data.title || ''}">
                    <input type="text" placeholder="Periode (Contoh: Jan 2020 - Des 2022)" class="exp-period w-full border p-2 rounded" value="${data.period || ''}">
                    <textarea placeholder="Deskripsi Pekerjaan" class="exp-desc w-full border p-2 rounded" rows="2">${data.desc || ''}</textarea>
                </div>
            `;
            container.appendChild(div);
        }

        const initEducation = (dataArray = []) => {
            const container = document.getElementById('educationList');
            container.innerHTML = ''; 
            for(let i=0; i<2; i++) {
                const data = dataArray[i] || {};
                const div = document.createElement('div');
                div.className = "p-4 border rounded bg-gray-50";
                div.innerHTML = `
                    <p class="text-xs text-gray-500 mb-1">Pendidikan ${i+1}</p>
                    <div class="grid grid-cols-1 gap-2">
                        <input type="text" placeholder="Nama Institusi" class="edu-school w-full border p-2 rounded" value="${data.school || ''}">
                        <input type="text" placeholder="Jurusan & Gelar" class="edu-degree w-full border p-2 rounded" value="${data.degree || ''}">
                        <div class="flex gap-2">
                            <input type="text" placeholder="Tahun Lulus" class="edu-year w-full border p-2 rounded" value="${data.year || ''}">
                            <input type="text" placeholder="IPK (Opsional)" class="edu-gpa w-full border p-2 rounded" value="${data.gpa || ''}">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        window.addSkill = (listId, value = '') => {
            const container = document.getElementById(listId);
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="text" class="skill-input w-full border p-2 rounded" placeholder="Nama Skill" value="${value}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2">-</button>
            `;
            container.appendChild(div);
        }

        window.addAdditional = (data = {}) => {
            const container = document.getElementById('additionalList');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-start border p-3 rounded bg-white relative";
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 w-full">
                    <input type="text" placeholder="Judul (Misal: Bahasa)" class="add-title w-full border p-2 rounded" value="${data.title || ''}">
                    <input type="text" placeholder="Keterangan (Misal: Inggris, Jerman)" class="add-desc w-full border p-2 rounded" value="${data.desc || ''}">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2 self-center">X</button>
            `;
            container.appendChild(div);
        }

        async function loadUserData(uid) {
            const snapshot = await get(ref(db, 'users/' + uid));
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                document.getElementById('fullName').value = data.fullName || '';
                document.getElementById('location').value = data.location || '';
                
                if(data.whatsapp) {
                    const wa = data.whatsapp; 
                    if (wa.startsWith('62')) {
                        document.getElementById('countryCode').value = '62';
                        const rawNum = wa.substring(2);
                        let x = rawNum.replace(/\D/g, '').match(/(\d{0,3})(\d{0,4})(\d{0,4})/);
                        document.getElementById('whatsapp').value = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
                    } else {
                        document.getElementById('whatsapp').value = wa;
                    }
                }

                document.getElementById('summary').value = data.summary || '';
                document.getElementById('photoBase64').value = data.photo || '';

                if (data.photo) {
                    const img = document.getElementById('photoPreview');
                    img.src = data.photo;
                    img.classList.remove('hidden'); 
                    document.getElementById('noPhotoText').classList.add('hidden'); 
                }

                if(data.experience) data.experience.forEach(exp => addExperience(exp));
                else addExperience(); 

                initEducation(data.education);

                if(data.hardSkills) data.hardSkills.forEach(s => addSkill('hardSkillsList', s));
                else addSkill('hardSkillsList');
                
                if(data.softSkills) data.softSkills.forEach(s => addSkill('softSkillsList', s));
                else addSkill('softSkillsList');

                if(data.additional) data.additional.forEach(add => addAdditional(add));
            } else {
                addExperience();
                initEducation();
                addSkill('hardSkillsList');
                addSkill('softSkillsList');
            }

            // UPDATE: Simpan Snapshot Data Awal setelah loading selesai
            // Ini dianggap "Sama dengan Firebase"
            savedStateJSON = JSON.stringify(getCurrentFormData());
        }

        document.getElementById('cvForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ambil data menggunakan fungsi yang sama
            const formData = getCurrentFormData();

            try {
                await set(ref(db, 'users/' + currentUser.uid), formData);
                await set(ref(db, 'slugs/' + formData.slug), currentUser.uid);

                // UPDATE: Karena berhasil disimpan, update Snapshot terbaru
                savedStateJSON = JSON.stringify(formData);

                alert('CV Berhasil disimpan! Mengalihkan ke halaman link...');
                window.location.href = `overview.html?id=${formData.slug}`;
                
            } catch (error) {
                alert("Gagal menyimpan: " + error.message);
            }
        });

        // 4. LOGIC GAMBAR DENGAN CROPPER
        let cropper; 
        const modal = document.getElementById('cropModal');
        const imageElement = document.getElementById('imageToCrop');

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.match('image.*')) {
                alert("Mohon pilih file gambar (JPG/PNG)");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(evt) {
                e.target.value = ''; 

                imageElement.src = evt.target.result;
                modal.classList.remove('hidden');

                if (cropper) { cropper.destroy(); }
                
                cropper = new Cropper(imageElement, {
                    aspectRatio: 3 / 4,    
                    viewMode: 1,           
                    dragMode: 'move',      
                    autoCropArea: 1,       
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('btnCancelCrop').addEventListener('click', () => {
            modal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });

        document.getElementById('btnSaveCrop').addEventListener('click', () => {
            if (!cropper) return;

            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 400,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });

            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

            document.getElementById('photoBase64').value = dataUrl;
            
            const previewImg = document.getElementById('photoPreview');
            previewImg.src = dataUrl;
            previewImg.classList.remove('hidden');
            document.getElementById('noPhotoText').classList.add('hidden');

            modal.classList.add('hidden');
            cropper.destroy();
            cropper = null;
        });
    </script>

    <div id="cropModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Sesuaikan Foto (3:4)</h3>
            
            <div class="relative w-full h-80 bg-gray-100 overflow-hidden rounded mb-4">
                <img id="imageToCrop" src="" class="block max-w-full">
            </div>

            <div class="flex justify-end gap-3 mt-auto">
                <button type="button" id="btnCancelCrop" class="px-4 py-2 rounded text-gray-600 hover:bg-gray-100 font-semibold border">
                    Batal
                </button>
                <button type="button" id="btnSaveCrop" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 font-bold shadow">
                    <i class="fas fa-check mr-1"></i> Simpan Foto
                </button>
            </div>
        </div>
    </div>

</body>
</html>
